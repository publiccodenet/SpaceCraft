###################################################################################################
# Build Unity SpaceCraft â€“ GitHub Actions (Ubuntu runner)
#
# Overview
# - Builds the Unity SpaceCraft project for WebGL on GitHub-hosted Linux runners.
# - Auto-detects Unity version from ProjectVersion.txt (override via input).
# - Supports Production/Development profiles or a fully custom build method.
# - Caches the Unity Library folder for faster imports/compiles between runs.
# - Downloads real LFS asset blobs for the checked-out commit (required for Unity).
# - Uploads build artifacts for later download/deploy.
#
# Requirements (repo secrets)
# - UNITY_LICENSE: Unity license file contents (game-ci format) or ULF text.
# - UNITY_EMAIL: Unity account email (for legacy activation flows in builder).
# - UNITY_PASSWORD: Unity account password (for legacy activation flows in builder).
#
# Inputs (workflow_dispatch)
# - unityVersion: Unity Editor version (e.g., 2022.3.45f1). Use 'auto' to parse ProjectVersion.txt.
# - projectPath: Path to the Unity project. Defaults to Unity/SpaceCraft.
# - targetPlatform: Build target (WebGL). Extendable if needed.
# - buildProfile: Convenience selector mapping to build methods (Production/Development).
# - buildMethod: Explicit Unity C# method string, overrides buildProfile. Example:
#     SpaceCraft.Editor.Builds.BuildWebGLProduction
#
# Build method expectations (Unity side)
# - The selected build method should be a static C# function callable by Unity with:
#     - No arguments (or signature supported by Unity batchmode).
#     - It should configure build options and write the WebGL build output into the project Build/ path
#       or another deterministic directory consumed by artifact upload below.
# - Example namespace/class/method naming is provided here as a convention; implement accordingly.
#
# Caching strategy
# - Caches the Library/ folder per (OS, Unity version, Packages/manifest.json hash) to reduce reimport.
# - On cache hits, compilations and imports should be much faster.
# - We intentionally do not cache Temp/ or final Build/ outputs; those are uploaded as artifacts.
#
# LFS and checkout
# - actions/checkout is configured with lfs: true and fetch-depth: 1
#   - Ensures real LFS blobs for the current commit are available to the build.
#   - Uses shallow history for speed (no need for full Git history in CI).
#
# Artifacts
# - Uploads the default game-ci build/ directory and the project Build/ directory.
# - Adjust artifact paths if your build method writes to a different location.
#
# Invocation examples
# - Production (auto-detect Unity, default project path):
#     unityVersion: auto
#     buildProfile: WebGLProductionBuild
# - Development:
#     unityVersion: auto
#     buildProfile: WebGLDevelopmentBuild
# - Explicit method (overrides profile mapping):
#     buildMethod: SpaceCraft.Editor.Builds.BuildWebGLProduction
#
# Notes
# - This workflow focuses on GitHub-hosted runners (no self-hosted required).
# - For further speed-ups, consider enabling editor caching in the action if appropriate and supported
#   by your environment, or splitting content generation into a separate, cacheable step.
###################################################################################################
name: Build Unity SpaceCraft

on:
  workflow_dispatch:
    inputs:
      unityVersion:
        description: "Unity Editor version (e.g. 2022.3.45f1). Use 'auto' to detect from ProjectVersion.txt"
        required: false
        default: "auto"
        type: string
      projectPath:
        description: "Unity project path"
        required: false
        default: "Unity/SpaceCraft"
        type: string
      targetPlatform:
        description: "Unity target platform"
        required: false
        default: "WebGL"
        type: choice
        options:
          - WebGL
      buildProfile:
        description: "Build profile token (maps to a Unity build method)"
        required: false
        default: "WebGLProductionBuild"
        type: choice
        options:
          - WebGLProductionBuild
          - WebGLDevelopmentBuild
      buildMethod:
        description: "Explicit Unity build method (overrides buildProfile). Example: SpaceCraft.Editor.Builds.BuildWebGLProduction"
        required: false
        default: ""
        type: string

jobs:
  build:
    name: Build ${{ inputs.targetPlatform }} (${{ inputs.buildProfile }})
    runs-on: ubuntu-latest

    env:
      PROJECT_PATH: ${{ inputs.projectPath }}
      TARGET_PLATFORM: ${{ inputs.targetPlatform }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 1

      - name: Detect Unity version from ProjectVersion.txt
        id: detect
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${{ inputs.unityVersion }}" != "auto" && -n "${{ inputs.unityVersion }}" ]]; then
            echo "Using provided unityVersion: ${{ inputs.unityVersion }}"
            echo "version=${{ inputs.unityVersion }}" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          FILE="${{ github.workspace }}/${{ inputs.projectPath }}/ProjectSettings/ProjectVersion.txt"
          if [[ ! -f "$FILE" ]]; then
            echo "ProjectVersion.txt not found at: $FILE" >&2
            exit 1
          fi
          VERSION=$(grep -E "^m_EditorVersion:\s*" "$FILE" | sed -E 's/^m_EditorVersion:\s*([^[:space:]]+).*/\1/')
          if [[ -z "$VERSION" ]]; then
            echo "Failed to parse Unity version from ProjectVersion.txt" >&2
            exit 1
          fi
          echo "Detected Unity version: $VERSION"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Cache Unity Library (project import cache)
        uses: actions/cache@v4
        with:
          path: |
            ${{ inputs.projectPath }}/Library
          key: ${{ runner.os }}-unity-library-${{ steps.detect.outputs.version }}-${{ hashFiles(format('{0}/Packages/manifest.json', inputs.projectPath)) }}
          restore-keys: |
            ${{ runner.os }}-unity-library-${{ steps.detect.outputs.version }}-

      - name: Compute build method
        id: compute
        shell: bash
        run: |
          set -euo pipefail
          if [[ -n "${{ inputs.buildMethod }}" ]]; then
            METHOD="${{ inputs.buildMethod }}"
          else
            case "${{ inputs.buildProfile }}" in
              WebGLProductionBuild)
                METHOD="SpaceCraft.Editor.Builds.BuildWebGLProduction"
                ;;
              WebGLDevelopmentBuild)
                METHOD="SpaceCraft.Editor.Builds.BuildWebGLDevelopment"
                ;;
              *)
                echo "Unknown buildProfile: ${{ inputs.buildProfile }}" >&2
                exit 1
                ;;
            esac
          fi
          echo "buildMethod=$METHOD" >> "$GITHUB_OUTPUT"

      - name: Unity - Builder
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          projectPath: ${{ inputs.projectPath }}
          targetPlatform: ${{ inputs.targetPlatform }}
          unityVersion: ${{ steps.detect.outputs.version }}
          buildMethod: ${{ steps.compute.outputs.buildMethod }}
          uses_custom_image: false
          # Optional: enable Unity editor cache inside action (requires action support)
          # cacheUnity: true
          # cacheVersioning: semantic

      - name: Upload build artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: SpaceCraft-${{ inputs.targetPlatform }}-${{ inputs.buildProfile }}
          path: |
            build
            ${{ inputs.projectPath }}/Build

