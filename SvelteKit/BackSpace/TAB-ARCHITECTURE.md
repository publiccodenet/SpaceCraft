# Tab Architecture Migration Guide

## Overview

This guide explains how to migrate SpaceCraft controllers from the current type-based system to the tab-based architecture found in the don-searcher branch. The tab system provides better separation of concerns and makes it easier to add new controller features.

### ðŸš¨ KEY PRINCIPLE: Dynamic Content Generation

**controller.html has an EMPTY BODY** - ALL content must be dynamically generated by JavaScript. No hardcoded HTML elements, no brittle boilerplate. This ensures:
- Clean separation of structure and logic
- Easy maintenance and refactoring
- Consistent UI generation patterns
- No HTML/JS synchronization issues

## Current Architecture (type-based)

```javascript
// Single controller class handles all types
class NavigatorController extends BaseController {
    constructor() {
        super('navigator');
    }
    
    createDOM() {
        // Creates different UI based on this.clientType
        if (this.clientType === 'navigator') {
            // Navigator UI
        } else if (this.clientType === 'selector') {
            // Selector UI
        }
    }
}
```

## New Architecture (tab-based)

```javascript
// Base controller manages tabs
class UnifiedController extends BaseController {
    constructor() {
        super('controller');
        this.tabs = {
            about: new AboutTab(this),
            navigate: new NavigateTab(this),
            select: new SelectTab(this),
            inspect: new InspectTab(this),
            adjust: new AdjustTab(this)
        };
    }
}

// Each tab is a separate class
class NavigateTab extends Tab {
    constructor(controller) {
        super(controller, 'navigate');
    }
    
    async initialize() {
        // Set up navigation-specific UI
    }
}
```

## Migration Steps

### Step 1: Create Base Tab Class

```javascript
window.Tab = class Tab {
    constructor(controller, tabId) {
        this.controller = controller;
        this.tabId = tabId;
        this.button = document.querySelector(`[data-tab="${tabId}"]`);
        this.pane = document.getElementById(`${tabId}-tab`);
        this.isActive = false;
        this.isInitialized = false;
    }
    
    async initialize() {
        this.isInitialized = true;
    }
    
    async activate() {
        if (!this.isInitialized) {
            await this.initialize();
        }
        this.isActive = true;
        this.pane.classList.add('active');
        this.button.classList.add('active');
        this.onActivate();
    }
    
    deactivate() {
        this.isActive = false;
        this.pane.classList.remove('active');
        this.button.classList.remove('active');
        this.onDeactivate();
    }
    
    onActivate() {}
    onDeactivate() {}
    updateFromState() {}
}
```

### Step 2: Extract Type-Specific Logic to Tab Classes

#### AboutTab
- Welcome message
- Help information
- Tab usage descriptions

#### NavigateTab
- Pan/zoom controls
- Touch/mouse input handling
- Search box (optional)

#### SelectTab
- Item selection
- Directional gestures
- Swipe handling
- Search box (optional)

#### InspectTab
- Archive.org iframe
- Item metadata / cover / page display (optional)

#### AdjustTab
- Settings controls
- Pan/zoom sensitivity
- Debug mode toggle

### Step 3: Update UnifiedController

```javascript
class UnifiedController extends BaseController {
    constructor() {
        super('controller');
        this.currentTab = null;
        this.tabs = {};
    }
    
    async initialize() {
        await super.initialize();
        
        // Create tabs
        this.tabs = {
            about: new AboutTab(this),
            navigate: new NavigateTab(this),
            select: new SelectTab(this),
            inspect: new InspectTab(this),
            adjust: new AdjustTab(this)
        };
        
        // Set up tab switching
        this.setupTabSwitching();
        
        // Activate default tab
        await this.switchToTab('about');
    }
    
    setupTabSwitching() {
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', (e) => {
                const tabId = e.target.dataset.tab;
                this.switchToTab(tabId);
            });
        });
    }
    
    async switchToTab(tabId) {
        if (this.currentTab) {
            this.currentTab.deactivate();
        }
        
        const tab = this.tabs[tabId];
        if (tab) {
            await tab.activate();
            this.currentTab = tab;
        }
    }
    
    updateUIFromState() {
        super.updateUIFromState();
        
        // Update all tabs
        Object.values(this.tabs).forEach(tab => {
            if (tab.isActive) {
                tab.updateFromState();
            }
        });
    }
}
```

### Step 4: Update HTML Structure

```javascript
// IMPORTANT: controller.html has an EMPTY BODY!
// ALL content is dynamically generated by JavaScript

// Example structure that will be created dynamically:
/*
<div class="container">
    <!-- Tab bar created by UnifiedController -->
    <div class="tab-bar">
        <!-- Tab buttons created by createTabButton() -->
    </div>
    
    <!-- Tab panes created by each Tab subclass -->
    <div id="about-tab" class="tab-pane active">
        <!-- Content created by AboutTab.createContent() -->
    </div>
    <div id="navigate-tab" class="tab-pane">
        <!-- Content created by NavigateTab.createContent() -->
    </div>
    <!-- etc... -->
</div>
*/

// The actual DOM creation happens in UnifiedController.createDOM():
createDOM() {
    document.body.innerHTML = ''; // Start with empty body
    
    // Create container
    const container = document.createElement('div');
    container.className = 'container';
    
    // Create tab bar
    const tabBar = document.createElement('div');
    tabBar.className = 'tab-bar';
    container.appendChild(tabBar);
    
    // Create tabs and panes...
    // NO HARDCODED HTML!
}
```

### Step 5: Update CSS

```css
.tab-bar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    display: flex;
    background: #2a2a2a;
    z-index: 100;
}

.tab-button {
    flex: 1;
    padding: 10px;
    background: transparent;
    border: none;
    color: #666;
    cursor: pointer;
}

.tab-button.active {
    background: #3a3a3a;
    color: white;
}

.tab-pane {
    display: none;
    padding-top: 50px; /* Space for tab bar */
}

.tab-pane.active {
    display: block;
}
```

## Benefits of Tab Architecture

1. **Separation of Concerns** - Each tab handles its own UI and logic
2. **Easier to Extend** - Add new tabs without modifying existing code
3. **Better Organization** - Related functionality grouped together
4. **Lazy Initialization** - Tabs only initialize when first accessed
5. **Clean Event Handling** - Each tab manages its own events

## Migration Checklist

- [ ] Create Tab base class
- [ ] Create AboutTab implementation
- [ ] Create NavigateTab implementation
- [ ] Create SelectTab implementation
- [ ] Create InspectTab implementation (fix mouse input!)
- [ ] Create AdjustTab implementation
- [ ] Update UnifiedController to manage tabs
- [ ] Update HTML structure
- [ ] Update CSS for tab UI
- [ ] Test all tab functionality
- [ ] Ensure backward compatibility with bridge messages
- [ ] Update QR codes if needed (should work with controller.html)

## Notes

- The controller type (now tab id) is still sent to Unity for future use
- Tab state persists when switching between tabs
- Search functionality can be shared between tabs that need it
- The tab system is compatible with all existing bridge communication
